#! /usr/bin/env bash

function calc() {
    bc -l <<< "$@"
}

function where(){
	find . -iname "*$1*"
}

function cm() { git commit -am "$*"; }

function replaceAll(){
	echo $PWD
	echo "s/$1/$2"
	find "$PWD" -type f -iname '*.js'  -exec sed -i "s/$1/$2/" {} \;
}

function jsx() {
	# npm install -g @ast-grep/cli
	local target="$1"

	_jsx_file() {
		local file="$1"
		local lang="javascript"
		[[ "$file" == *.ts || "$file" == *.tsx ]] && lang="typescript"

		declare -A patterns=(
			[const]='export const $NAME = $_'
			[let]='export let $NAME = $_'
			[function]='export function $NAME($_) { $$$ }'
			[class]='export class $NAME { $$$ }'
			[type]='export type $NAME = $_'
			[interface]='export interface $NAME { $$$ }'
		)

		for kind in "${!patterns[@]}"; do
			ast-grep --pattern "${patterns[$kind]}" -l "$lang" --json "$file" 2>/dev/null \
				| jq -r --arg kind "$kind" '.[].metaVariables.single.NAME.text | "\($kind):\t\(.)"' 2>/dev/null
		done | sort -k2 | column -t -s $'\t'
	}

	if [[ -d "$target" ]]; then
		find "$target" -type f \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \) | sort | while read -r file; do
			output=$(_jsx_file "$file")
			if [[ -n "$output" ]]; then
				echo "=== $file ==="
				echo "$output"
				echo
			fi
		done
	else
		_jsx_file "$target"
	fi
}
